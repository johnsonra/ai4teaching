# Copilot Instructions for ai4teaching

## Package overview

`ai4teaching` is an R package providing tools for integrating AI (currently Google Gemini) into teaching workflows. The primary use case is checking student answers against quiz questions via a generative AI backend.

## Build, test, and document commands

Run from an R session with the package root as working directory:

```r
devtools::load_all()      # load package for interactive development
devtools::document()      # regenerate NAMESPACE and man/ from roxygen2 comments
devtools::check()         # full R CMD check
devtools::test()          # run all tests

# Run a single test file
testthat::test_file("tests/testthat/test-gemini_query.R")
```

## Architecture

`genAI_query()` is the top-level public dispatcher. It inspects the `model` argument and routes to the appropriate backend function (currently only `gemini_query()`). New model backends should be added here.

`gemini_query()` handles the actual Gemini REST API call via `httr2`. It returns a `gemini_response` S3 object — a list with two fields:
- `$response`: character string with the model's reply
- `$history`: a `gemini_history`-classed list of all turns in the conversation

`check_answer()` is a teaching-specific wrapper: it uses `construct_preamble()` to build a grading-style prompt and passes it to `genAI_query()`.

`addHistory()` is an **internal** (unexported) helper that appends a turn to the history list in Gemini's API format: `list(role, parts = list(list(text = ...)))`.

## Key conventions

**API key management:** API keys are retrieved via `OPsecrets::get_secret("GEMINI_API_KEY")` (a GitHub-only package from `johnsonra/OPsecrets`). Never hardcode keys. Tests skip automatically when the key is unavailable.

**S3 classes:** Return objects carry meaningful classes — always set `class(retval) <- c('gemini_response', 'list')` (and `gemini_history` for history lists). Add S3 methods (e.g., `print`) in `R/print.R`.

**NAMESPACE:** Generated by roxygen2 — do not edit by hand. Use `@importFrom pkg fun` tags rather than `@import pkg`.

**Optional parameters pattern:** `gemini_query()` accepts extra arguments via `...` collected into `optional <- list(...)`, with `NULL`-checked defaults applied afterward. Follow this pattern when adding new model-level parameters.

**History format:** Gemini conversation history is a list of turns, each structured as `list(role = "user"|"model", parts = list(list(text = "...")))`. Use `addHistory()` to append turns.

**Tests:** Use testthat edition 3. Tests that require a live API key must call `skip()` when the key is unavailable (see existing test for the pattern). Tested models: `gemini-2.5-flash` (default), `gemini-2.5-flash-lite`, `gemini-1.5-flash`, `gemini-1.5-pro`.
